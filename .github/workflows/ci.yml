name: Artifex CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v1
        with:
          enable-cache: true
          cache-suffix: "lint"

      - name: Create virtual environment
        run: |
          uv venv

      - name: Install dependencies
        run: |
          uv pip install -e ".[dev]"
          # Install type stubs for common libraries
          uv pip install types-requests types-setuptools

      - name: Setup PYTHONPATH for tests
        run: |
          echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

      - name: Run Ruff
        run: |
          uv run ruff check .

      - name: Run Pyright
        run: |
          uv run pyright || echo "Pyright check completed with issues"

  unit_tests:
    name: Unit Tests (${{ matrix.os }})
    needs: lint
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-14]
        python-version: ['3.11']
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v1
        with:
          enable-cache: true
          cache-suffix: "unit-${{ matrix.python-version }}-${{ matrix.os }}"

      - name: Create virtual environment
        run: |
          uv venv

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          uv pip install -e ".[dev,test]"

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          # Install without CUDA dependencies for macOS
          # Note: TFDS tests are skipped on macOS due to TensorFlow ARM64 import hang issue
          # (https://github.com/tensorflow/tensorflow/issues/52138)
          # Retry logic for transient network errors (error 55: No buffer space available)
          for i in 1 2 3; do
            uv pip install -e ".[all-cpu]" && break
            echo "Attempt $i failed, retrying in 10 seconds..."
            sleep 10
          done

      - name: Setup PYTHONPATH for tests
        run: |
          echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

      - name: Run unit tests with coverage
        run: |
          # Explicitly run on CPU for GitHub workflow
          export JAX_PLATFORMS="cpu"
          # Run all tests except GPU-specific ones (tests don't use unit/integration markers)
          uv run pytest tests/ -v -m "not gpu and not gpu_required and not cuda and not slow and not blackjax" \
            --cov=src/artifex --cov-report=xml --cov-report=term-missing \
            --ignore=tests/artifex/generative_models/training/distributed/
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests-${{ matrix.os }}
          fail_ci_if_error: false
        if: always()

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results-${{ matrix.python-version }}-${{ matrix.os }}
          path: |
            .coverage
            coverage.xml
            test-results/
        if: always()

  integration_tests:
    name: Integration Tests
    needs: unit_tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v1
        with:
          enable-cache: true
          cache-suffix: "integration"

      - name: Create virtual environment
        run: |
          uv venv

      - name: Install dependencies
        run: |
          uv pip install -e ".[dev,test]"

      - name: Setup PYTHONPATH for tests
        run: |
          echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

      - name: Run integration tests
        run: |
          # Explicitly run on CPU for GitHub workflow
          export JAX_PLATFORMS="cpu"
          # Run integration tests (tests marked with integration or in integration directories)
          uv run pytest tests/artifex/generative_models/integration/ -v -m "not gpu and not gpu_required and not cuda" \
            --cov=src/artifex --cov-report=xml --cov-report=term-missing
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: integration
          fail_ci_if_error: false
        if: always()

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            .coverage
            coverage.xml
            test-results/
        if: always()

  e2e_tests:
    name: End-to-End Tests
    needs: integration_tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v1
        with:
          enable-cache: true
          cache-suffix: "e2e"

      - name: Create virtual environment
        run: |
          uv venv

      - name: Install dependencies
        run: |
          uv pip install -e ".[dev,test]"

      - name: Setup PYTHONPATH for tests
        run: |
          echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

      - name: Run end-to-end tests
        run: |
          # Explicitly run on CPU for GitHub workflow
          export JAX_PLATFORMS="cpu"
          # Run e2e tests (tests marked with e2e marker)
          uv run pytest tests/ -v -m "e2e and not gpu and not gpu_required and not cuda" \
            --cov=src/artifex --cov-report=xml --cov-report=term-missing || echo "No e2e tests found or all skipped"
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: e2e
          fail_ci_if_error: false
        if: always()

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            .coverage
            coverage.xml
            test-results/
        if: always()

  performance_tests:
    name: Performance Tests
    needs: unit_tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v1
        with:
          enable-cache: true
          cache-suffix: "perf"

      - name: Create virtual environment
        run: |
          uv venv

      - name: Install dependencies
        run: |
          uv pip install -e ".[dev,test]"

      - name: Setup PYTHONPATH for tests
        run: |
          echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

      - name: Run performance tests
        run: |
          # Explicitly run on CPU for GitHub workflow
          export JAX_PLATFORMS="cpu"
          # Run benchmark tests (tests marked with benchmark or performance marker)
          uv run pytest tests/ -v -m "(benchmark or performance) and not gpu and not gpu_required and not cuda" --benchmark-autosave --benchmark-columns=mean,stddev,min,max --no-cov || echo "No benchmark tests found or all skipped"
        continue-on-error: true

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            benchmark-results/
            benchmark.json
            histogram.svg
        if: always()

  coverage:
    name: Test Coverage
    needs: [unit_tests, integration_tests, e2e_tests]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v1
        with:
          enable-cache: true
          cache-suffix: "coverage"

      - name: Create virtual environment
        run: |
          uv venv

      - name: Install dependencies
        run: |
          uv pip install -e ".[dev,test]"

      - name: Setup PYTHONPATH for tests
        run: |
          echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

      - name: Download all coverage reports
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Debug artifact contents
        run: |
          echo "Listing artifact directory structure:"
          find artifacts -type f | sort
          echo "Checking for .coverage files:"
          find artifacts -name ".coverage" | sort

      - name: Combine coverage reports
        run: |
          # First check if any .coverage files exist
          if ls artifacts/*/.coverage 1> /dev/null 2>&1; then
            uv run coverage combine artifacts/*/.coverage
          else
            echo "No .coverage files found to combine, creating empty coverage report"
            uv run coverage run --source=src/artifex -m pytest --collect-only
          fi
          uv run coverage report
          uv run coverage xml
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

      - name: Upload combined coverage report
        uses: actions/upload-artifact@v4
        with:
          name: combined-coverage-report
          path: coverage.xml
        if: always()

  build:
    name: Build Package
    needs: lint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v1
        with:
          enable-cache: true
          cache-suffix: "build"

      - name: Create virtual environment
        run: |
          uv venv

      - name: Install dependencies
        run: |
          uv pip install -e ".[dev]"

      - name: Build package
        run: |
          uv run python -m build

      - name: Check package
        run: |
          uv run twine check dist/*

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: package-artifacts
          path: dist/
